# KOOK_BOT v1.3.1.0 版本说明
**发布日期**：2025-06-05  
**版本类型**：功能版本（FEATURE）


## 一、版本核心变更
### 1. 新增功能
- **✅️集成FF14市场数据查询模块**  
通过引入独立类文件 FF14_Price_Query.py，新增四个指令实现游戏内经济系统数据查询:  

  
| 指令格式          | 功能描述         | 关联方法       |
|-------------------|------------------|----------------|
| /tax {大区名}           | 查询指定大区各城市税率（如利姆萨・罗敏萨、乌尔达哈等）    | get_market_tax_rates()        | 
| /query {服务器名} {物品名}   | 查询物品当前价格信息（含 NQ/HQ 最低售价、平均售价、日销量）           | item_query()  |  
| /sold {大区名} {物品名} {条目数量}	   | 查询物品历史销售记录（支持指定返回条数，最多 100 条）           | get_sale_history()|  
| /market {大区名} {物品名} | 查询市场板实时上架信息（显示普通 / 高品质物品的价格、数量、卖家等详情）| get_formatted_market_listings() |  
  
- **🛠️查询时会显示物品的图片**  
通过API提供的ICO图标的url链接，可以在查询时显示物品的图片


**示例输出**：  
```text  
/query 海猫茶屋 黑星石
 
NQ:  
1. 最低售价：742(服务器：摩杜纳, 数据上传时间：2025-06-03 12:19:48)  
2. 平均售价：957.25  
HQ:  
1. 最低售价：788(服务器：静语庄园, 数据上传时间：2025-06-03 01:14:43)


/tax 海猫茶屋

📊 海猫茶屋 大区税率（数据来源：Universalis）：
利姆萨·罗敏萨: 5.00%
格里达尼亚: 5.00%
乌尔达哈: 5.00%
伊修加德: 3.00%
黄金港: 3.00%
水晶都: 3.00%
旧萨雷安: 3.00%
图莱尤拉: 3.00%


/sold 猫小胖 椰奶 5

==== 椰奶 销售历史（共5条） ====

第1条:
服务器: 柔风海湾
品质: NQ
单价: 400 gil
数量: 15
总价: 6,000 gil
售出时间: 2025-06-04 00:08:09
买家名称: 汐音

... ...
... ...

第5条:
服务器: 海猫茶屋
品质: NQ
单价: 400 gil
数量: 7
总价: 2,800 gil
售出时间: 2025-06-03 23:00:12
买家名称: 乌拉拉提亚


/market 猫小胖 巨匠药酒

【普通品质 (NQ)】前10条:

第1条
服务器: 琥珀原
单价: 197 gil
数量: 1 ×
雇员: 狗茶兔
总价: 197 gil
上架时间: 2025-06-04 01:54:31
... ...
... ...
第10条
服务器: 静语庄园
单价: 400 gil
数量: 6 ×
雇员: 姜尚
总价: 2400 gil
上架时间: 2025-06-04 09:24:30
【高品质 (HQ)】前10条:

第1条 ★
服务器: 延夏
单价: 600 gil
数量: 1 ×
雇员: 克罗涅索
总价: 600 gil
上架时间: 2025-06-04 09:18:58
... ...
... ...
第10条 ★
服务器: 静语庄园
单价: 618 gil
数量: 99 ×
雇员: ·雅·修特拉
总价: 61182 gil
上架时间: 2025-06-04 09:24:30
```
### 2. 功能优化
- **指令提示优化**  
  🛠️ 指令提示优化：  
  - 当输入指令识别符后，机器人回复用法和示例：  
    ```text  
    /market
    用法：/market {大区名} {物品名}
    示例：/market 猫小胖 黑星石
## 二、兼容性说明
### 1. 新增依赖  
| 组件名称          | 版本要求         | 用途       |  
|-------------------|------------------|----------------|
| requests	      | ≥2.26.0     | 调用 Universalis API 获取游戏数据   |
| python-dateutil	   | ≥2.8.2  | 时间戳解析与格式化              |
### 2. 系统影响
  1. Windows 用户：需确保 ffmpeg 路径已添加到系统环境变量（与原有音乐播放功能共用）  
  2. 开发环境：新增 FF14_Price_Query.py 类文件，需与主程序放置于同目录


## 三、本地部署指南  
### 1. 快速升级（普通用户）  
📥 **下载地址**：  
[Windows 可执行文件](https://github.com/ChadQin/KOOK_BOT/raw/refs/heads/master/kook_bot.exe)  
[Windows 可执行文件(国内gitee)](https://gitee.com/chadqin/KOOK_BOT/raw/master/kook_bot.exe)  
（文件大小：39.6MB，SHA256校验码：`a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c`）  

🔧 **操作步骤**：  
1. 备份原 FF14_Price_Query.py 文件（如有二次开发）；  
2. 将下载新版本压缩包，解压后覆盖以下文件：
   - kook_bot.exe（主程序）
   - FF14_Price_Query.py（新增类文件）  
3. 双击新文件启动程序，控制台将显示 `[INFO] 版本号：v1.3.0.0`。
4. 首次运行会自动拉取游戏物品数据缓存（约需 30 秒）

## 四、贡献者名单
| 贡献者          | 角色描述         |
|-------------------|------------------|
| @ChadQin           | 核心逻辑开发、版本发布    | 
| @Acha   | 算法模块优化（选手猜测功能）&服务器端测试 |
 
## 五、版本规范说明  
### 1. 日志符号约定  
| 符号   | 含义                 | 示例                     |  
|--------|----------------------|--------------------------|  
| ✅     | 新增功能             | ✅ 支持自定义指令前缀    |  
| 🛠️     | 功能优化             | 🛠️ 提升数据库查询速度    |  
| 🐛     | Bug 修复              | 🐛 修复消息重复发送问题  |  
| ⚠️     | 破坏性变更           | ⚠️ 移除旧版 API 接口      |  

### 2. 新增符号约定  
| 符号   | 含义                 | 示例                     |  
|--------|----------------------|--------------------------|  
| 📚    | 文档更新             | 📚 新增 FF14 指令使用说明(目前未更新)    | 


## 六、反馈与支持  
### 1. 问题反馈渠道  
| 渠道类型         | 适用场景                 | 链接/方式                          | 响应时间       |  
|------------------|--------------------------|-----------------------------------|----------------|  
| 🐞 **GitHub Issues** | 功能建议、Bug 报告       | [点击提交](https://github.com/ChadQin/KOOK_BOT/issues) | 工作日 24 小时内 |  
| 💬 **KOOK 官方服务器** | 实时技术交流             | [加入服务器](https://kook.vip/IjKSYi) | 在线时段即时响应 |  
| 📧 **邮箱**       | 敏感问题或私密信息       | qq760533763@outlook.com              | 48 小时内      |  

### 2. 新增反馈标签  
在 GitHub Issues 提交反馈时，可添加以下标签：
- `f14-market`：与 FF14 市场查询功能相关的问题
- `command-parser`：指令参数解析异常

### 3. 贡献代码指南  
1. **Fork 仓库**：点击 GitHub 页面右上角 "Fork" 按钮；  
2. **创建分支**：基于 `develop` 分支创建新功能分支（如 `feature/new-command`）；  
3. **提交 PR**：完成开发后向 `develop` 分支提交 Pull Request。  

🔍 **代码规范**：  
- 使用 PEP 8 代码风格（建议安装 autopep8 自动格式化）；  
- 新增功能需包含单元测试（测试覆盖率 ≥80%）；  
- 提交前运行 `flake8` 检查代码质量。  

### 3. 常见问题（FAQ）  
#### Q1：机器人无法连接 KOOK 服务器？  
A：检查以下内容：  
1. 网络连接是否正常；  
2. Bot Token 是否正确（可在 [KOOK 开发者后台](https://developer.kookapp.cn) 重置）；  
3. 防火墙是否放行 443 端口。  

### 4. 技术文档与教程  
- 📚 **官方文档**：[KOOK_BOT 文档中心](https://developer.kookapp.cn)  
- 🎬 **视频教程**：[暂无](https://www.bilibili.com/)  
- 📖 **API 参考**：[API 文档](https://khl-py.eu.org/)

## 七、已知问题
1. **物品名称匹配问题**：部分繁体中文物品名可能无法正确识别（如 “图莱尤拉炖沼泽鬼鱼” 与 “圖萊尤拉燉沼澤鬼魚”），建议使用游戏内简体中文名查询
2. **数据延迟**：API 数据不定期通过用户上传更新一次，查询结果可能存在时效性差异

**后续计划**  
- 机器人回复以卡片形式回复，阅读美观，所占空间小(因KOOK卡片消息API调用问题，该计划可能无限期延后)
- 支持物品价格波动图表生成（需安装 matplotlib）
- 查询时附带物品图片
